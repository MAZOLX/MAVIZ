<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MAVIZ - MLM Platform</title>
  <style>
    :root {
      --primary: #4a6bff;
      --secondary: #f8f9fa;
      --accent: #17c964;
      --text: #333;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      background-color: #f5f7fa;
      color: var(--text);
      line-height: 1.6;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      padding: 2rem;
      margin-bottom: 2rem;
    }
    h1, h2, h3 {
      color: var(--primary);
      margin-bottom: 1rem;
    }
    input, select {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    button {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    button:hover {
      background-color: #3a5bef;
      transform: translateY(-2px);
    }
    .position-option {
      display: flex;
      align-items: center;
      margin: 12px 0;
    }
    .position-option select {
      width: auto;
      margin-left: 12px;
    }
    .hidden {
      display: none;
    }
    #wallet-status {
      font-weight: 600;
      color: var(--accent);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>MAVIZ MLM Platform</h1>
      <div id="wallet-status">Not connected</div>
    </header>

    <div class="card">
      <h2>Purchase MVZx Tokens</h2>
      <p>Minimum purchase: ₦2,000 (1 slot)</p>

      <div class="purchase-method">
        <h3>Automatic Placement</h3>
        <p>System will optimally position your slots</p>
        <input type="number" id="auto-amount" min="2000" step="100" placeholder="Enter amount in Naira">
        <button id="btn-auto">Purchase Automatically</button>
      </div>

      <div class="divider" style="margin: 2rem 0; text-align: center;">OR</div>

      <div class="purchase-method">
        <h3>Manual Placement</h3>
        <p>Choose specific positions for each slot</p>
        <input type="number" id="manual-amount" min="2000" step="100" placeholder="Enter amount in Naira">
        <button id="btn-configure">Configure Positions</button>
        
        <div id="position-config" class="hidden">
          <h4>Slot Positions</h4>
          <div id="position-options"></div>
          <button id="btn-confirm">Confirm Purchase</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Your Network</h2>
      <div id="network-view">
        <p>Connect wallet to view your slots</p>
      </div>
    </div>
  </div>

  <script>
    // Global State
    let currentWallet = null;
    let currentPin = null;

    // DOM Elements
    const walletStatus = document.getElementById('wallet-status');
    const btnAuto = document.getElementById('btn-auto');
    const btnConfigure = document.getElementById('btn-configure');
    const btnConfirm = document.getElementById('btn-confirm');
    const positionConfig = document.getElementById('position-config');
    const positionOptions = document.getElementById('position-options');

    // Event Listeners
    btnAuto.addEventListener('click', purchaseAuto);
    btnConfigure.addEventListener('click', configurePositions);
    btnConfirm.addEventListener('click', purchaseManual);

    // Connect Wallet (Mock - integrate your actual wallet connection)
    async function connectWallet() {
      if (typeof window.ethereum !== 'undefined') {
        try {
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          currentWallet = accounts[0];
          walletStatus.textContent = `Connected: ${currentWallet.substring(0, 6)}...${currentWallet.substring(38)}`;
          
          // Prompt for PIN (in production, use secure auth flow)
          currentPin = prompt('Enter your 4-digit PIN');
          if (!currentPin || currentPin.length !== 4) {
            alert('Invalid PIN');
            currentWallet = null;
            walletStatus.textContent = 'Not connected';
          }
        } catch (error) {
          console.error('Wallet connection error:', error);
        }
      } else {
        alert('Please install MetaMask or another Web3 wallet');
      }
    }

    // Automatic Purchase
    async function purchaseAuto() {
      if (!currentWallet) {
        await connectWallet();
        if (!currentWallet) return;
      }

      const amount = parseFloat(document.getElementById('auto-amount').value);
      if (amount < 2000) {
        alert('Minimum purchase is ₦2,000');
        return;
      }

      try {
        const response = await fetch('/api/purchase/auto', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            amount,
            wallet: currentWallet,
            pin: currentPin
          })
        });

        const result = await response.json();
        if (result.success) {
          alert(`Success! Purchased ${result.slotsPurchased} slots and credited ${result.mvzxCredited} MVZx`);
          updateNetworkView();
        } else {
          alert(`Error: ${result.error}`);
        }
      } catch (error) {
        alert('Purchase failed: ' + error.message);
      }
    }

    // Manual Position Configuration
    function configurePositions() {
      if (!currentWallet) {
        connectWallet();
        return;
      }

      const amount = parseFloat(document.getElementById('manual-amount').value);
      const slotCount = Math.floor(amount / 2000);

      if (amount < 2000) {
        alert('Minimum purchase is ₦2,000');
        return;
      }

      positionOptions.innerHTML = '';
      for (let i = 0; i < slotCount; i++) {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'position-option';
        optionDiv.innerHTML = `
          <label>Slot ${i + 1}:</label>
          <select id="slot-${i}">
            <option value="auto">Auto (Recommended)</option>
            <option value="left">Left Leg</option>
            <option value="right">Right Leg</option>
          </select>
        `;
        positionOptions.appendChild(optionDiv);
      }

      positionConfig.classList.remove('hidden');
    }

    // Manual Purchase Execution
    async function purchaseManual() {
      const amount = parseFloat(document.getElementById('manual-amount').value);
      const slotCount = Math.floor(amount / 2000);
      const positions = [];

      for (let i = 0; i < slotCount; i++) {
        const select = document.getElementById(`slot-${i}`);
        positions.push(select.value === 'auto' ? null : select.value);
      }

      try {
        const response = await fetch('/api/purchase/manual', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            amount,
            wallet: currentWallet,
            pin: currentPin,
            positions
          })
        });

        const result = await response.json();
        if (result.success) {
          alert(`Success! Purchased ${result.slotsPurchased} slots at your chosen positions and credited ${result.mvzxCredited} MVZx`);
          positionConfig.classList.add('hidden');
          updateNetworkView();
        } else {
          alert(`Error: ${result.error}`);
        }
      } catch (error) {
        alert('Purchase failed: ' + error.message);
      }
    }

    // Network Visualization
    async function updateNetworkView() {
      if (!currentWallet) return;

      try {
        const response = await fetch(`/api/user/slots?wallet=${currentWallet}`);
        const data = await response.json();
        
        // Render tree visualization (simplified)
        let html = '<h3>Your Slots</h3><ul>';
        data.slots.forEach(slot => {
          html += `<li>Level ${slot.level} - ${slot.position} leg</li>`;
        });
        html += '</ul>';

        document.getElementById('network-view').innerHTML = html;
      } catch (error) {
        console.error('Failed to load network:', error);
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      // Check for wallet connection
      if (typeof window.ethereum !== 'undefined') {
        window.ethereum.on('accountsChanged', (accounts) => {
          if (accounts.length === 0) {
            currentWallet = null;
            walletStatus.textContent = 'Not connected';
          }
        });
      }
    });
  </script>
</body>
</html>
